binlog2sql_audit
========================

本工具是基于优秀项目binlog2sql改的，并且大部分代码基于binlog2sql，做了部分修改，旨在记录生产环境数据变更日志，包括`ddl`跟`dml`

用途
===========

* 记录生产环境数据变更日志，做审计用途

# 说明

* 已测试环境
    * Python 3.6+
    * MySQL 5.7

- 安装

```
shell> git clone git@github.com:xuclachina/dbatools.git && cd binlog2sql_audit
shell> pip install -r requirements.txt
```
- 使用

MySQL server必须设置以下参数:

    [mysqld]
    server_id = 1
    log_bin = /var/log/mysql/mysql-bin.log
    max_binlog_size = 1G
    binlog_format = row
    binlog_row_image = full

user需要的最小权限集合：

    select, super/replication client, replication slave
    
    建议授权
    GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 

- 基本用法

```shell
xucldeMacBook-Pro:binlog2sql_audit xucl$ python3 binlog2sql_audit.py -h47.96.106.224 -P3306 -uxucl -p'xuclxucl' --start-file='mysql-binlog.000013' --start-pos=1932

说明：
-h：指定连接的数据库实例
-P：指定连接的数据库端口
-u：执行连接数据库的用户名
-p：执行连接数据库的密码
--start-file：指定binlog开始的文件
--start-pos：指定binlog开始的位置
```

- 日志输出格式

```
time:2019-04-22 14:56:07 type: insert sql: INSERT INTO `xucl`.`t`(`id`) VALUES (8);
time:2019-04-22 15:02:11 type: insert sql: INSERT INTO `xucl`.`t`(`id`) VALUES (11);
time:2019-04-22 15:02:29 type: insert sql: INSERT INTO `xucl`.`t`(`id`) VALUES (12);
time:2019-04-22 15:03:10 type: insert sql: INSERT INTO `xucl`.`t`(`id`) VALUES (13);
time:2019-04-22 15:03:31 type: ddl sql: USE xucl; create table zst(id int, name varchar(10));
time:2019-04-22 15:04:02 type: ddl sql: USE xucl; DROP TABLE `zst` /* generated by server */;
time:2019-04-22 15:07:33 type: ddl sql: USE xucl; create table zst(id int, name varchar(10));
time:2019-04-22 15:29:09 type: delete sql: DELETE FROM `xucl`.`t` WHERE `id`=1 LIMIT 1;
time:2019-04-22 15:29:09 type: delete sql: DELETE FROM `xucl`.`t` WHERE `id`=2 LIMIT 1;
time:2019-04-22 15:29:09 type: delete sql: DELETE FROM `xucl`.`t` WHERE `id`=3 LIMIT 1;
time:2019-04-22 15:29:09 type: delete sql: DELETE FROM `xucl`.`t` WHERE `id`=4 LIMIT 1;
time:2019-04-22 15:29:09 type: delete sql: DELETE FROM `xucl`.`t` WHERE `id`=5 LIMIT 1;
time:2019-04-22 15:29:09 type: delete sql: DELETE FROM `xucl`.`t` WHERE `id`=6 LIMIT 1;
time:2019-04-22 15:29:09 type: delete sql: DELETE FROM `xucl`.`t` WHERE `id`=7 LIMIT 1;
time:2019-04-22 15:29:09 type: delete sql: DELETE FROM `xucl`.`t` WHERE `id`=8 LIMIT 1;
time:2019-04-22 15:29:09 type: delete sql: DELETE FROM `xucl`.`t` WHERE `id`=11 LIMIT 1;
time:2019-04-22 15:29:09 type: delete sql: DELETE FROM `xucl`.`t` WHERE `id`=12 LIMIT 1;
time:2019-04-22 15:29:09 type: delete sql: DELETE FROM `xucl`.`t` WHERE `id`=13 LIMIT 1;

说明：
time：sql执行的时间
type：sql的类型，dml分为insert、update、delete，ddl统一为ddl
sql：sql的具体内容
```



